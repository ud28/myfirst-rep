/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2013 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ui.ux3.ToolPopup");jQuery.sap.require("sap.ui.ux3.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.ui.ux3.ToolPopup",{metadata:{publicMethods:["isOpen","open","close","setPosition","getEnabled"],library:"sap.ui.ux3",properties:{"title":{type:"string",group:"Misc",defaultValue:null},"icon":{type:"sap.ui.core.URI",group:"Misc",defaultValue:null},"iconHover":{type:"sap.ui.core.URI",group:"Misc",defaultValue:null},"iconSelected":{type:"sap.ui.core.URI",group:"Misc",defaultValue:null},"modal":{type:"boolean",group:"Behavior",defaultValue:false},"inverted":{type:"boolean",group:"Misc",defaultValue:true}},defaultAggregation:"content",aggregations:{"buttons":{type:"sap.ui.core.Control",multiple:true,singularName:"button"},"content":{type:"sap.ui.core.Control",multiple:true,singularName:"content"}},associations:{"initialFocus":{type:"sap.ui.core.Control",multiple:false},"opener":{type:"sap.ui.core.Control",multiple:false}},events:{"open":{},"close":{allowPreventDefault:true},"enter":{},"iconChanged":{},"closed":{}}}});sap.ui.ux3.ToolPopup.M_EVENTS={'open':'open','close':'close','enter':'enter','iconChanged':'iconChanged','closed':'closed'};jQuery.sap.require("sap.ui.core.Popup");jQuery.sap.require("sap.ui.core.theming.Parameters");sap.ui.ux3.ToolPopup.ARROW_LEFT=new RegExp(/my:(left|begin)(-+\d*\%?)?\|[a-z]+(-+\d*\%?)? at:(right|end)\|[a-z]+/);sap.ui.ux3.ToolPopup.ARROW_RIGHT=new RegExp(/my:(right|end)(-+\d*\%?)?\|[a-z]+(-+\d*\%?)? at:(left|begin)\|[a-z]+/);sap.ui.ux3.ToolPopup.ARROW_UP=new RegExp(/my:[a-z]+(-+\d*\%?)?\|top(-+\d*\%?)? at:[a-z]+\|bottom/);sap.ui.ux3.ToolPopup.ARROW_DOWN=new RegExp(/my:[a-z]+(-+\d*\%?)?\|bottom(-+\d*\%?)? at:[a-z]+\|top/);(function(){sap.ui.ux3.ToolPopup.prototype.init=function(){this.oPopup=null;this._bPositionSet=false;this._bFocusSet=false;this._proxyOpened=jQuery.proxy(p,this);this._proxyFixTooLargeContent=jQuery.proxy(f,this)};sap.ui.ux3.ToolPopup.prototype.exit=function(){if(this.oPopup){this.oPopup.detachClosed(jQuery.proxy(this.fireClosed,this));this.oPopup.detachOpened(this._proxyOpened);delete this.oPopup}delete this._bPositionSet;delete this._bFocusSet;delete this._proxyOpened;if(this._bBoundOnResize){jQuery(window).unbind("resize",this._proxyFixTooLargeContent)}delete this._bRTL;delete this.sArrowDir};var s=function(t){var i=t.getId();var $=jQuery.sap.byId(i+"-focusable");if(!t._bFocusSet){var a=jQuery(":sapFocusable",t.$());if(a.length>1){$.css("display","none");$=a[1]}$.focus()}else{$.css("display","none")}};var f=function(){var $=this.$();var h=$.height();var t=$.offset().top;h-=t;var w=jQuery(window).height();var a=jQuery.sap.byId(this.getId()+"-content");if(!this._bInitialFix||this._bInitialFix&&h>w){delete this._bInitialFix;var b=parseInt($.css("padding-bottom"));b+=parseInt($.css("border-bottom-width"))+75;w-=t+b;a.css("max-height",w+"px");a.addClass("sapUiUx3TPLargeContent");$.addClass("sapUiUx3TPLargeContent")}if(!this._bBoundOnResize){jQuery(window).bind("resize",this._proxyFixTooLargeContent);this._bBoundOnResize=true}};var p=function(){s(this);this._bInitialFix=true;this._proxyFixTooLargeContent()};sap.ui.ux3.ToolPopup.prototype.isOpen=function(){if(this.oPopup&&this.oPopup.isOpen()){return true}return false};sap.ui.ux3.ToolPopup.prototype.willBeClosed=function(){var e=this.oPopup&&this.oPopup.getOpenState();return e!==sap.ui.core.OpenState.OPENING&&e!==sap.ui.core.OpenState.OPEN};sap.ui.ux3.ToolPopup.prototype.open=function(m,a){this.sArrowDir=g(this,m,a);var o=null;var O="";if(!this._bPositionSet){var r="sap.ui.ux3.ToolPopup:";var A=r+"sapUiUx3ToolPopupArrowWidth";A=sap.ui.core.theming.Parameters.get(A);var i=parseInt(A,10);var b=0;if(!m){m=sap.ui.core.Popup.Dock.BeginTop}if(!a){a=sap.ui.core.Popup.Dock.EndTop}o=jQuery.sap.domById(this.getOpener());if(o){var $=jQuery.sap.byId(this.getOpener());var h=$.outerHeight(true);switch(this.sArrowDir){case"Up":i=0;b=parseInt(A,10);break;case"Down":i=0;b=parseInt(A,10)*-1;break;case"Right":i=parseInt(A,10)*-1;default:case"Left":b=(h/2)*-1;b=parseInt(b,10);break}O=""+i+" "+b;this.setPosition(m,a,o,O,"none");this._bPositionSet=false}else{jQuery.sap.log.warning("No opener set. Using a default position for Popup",this)}}this._ensurePopup();this.oPopup.setModal(this.getModal());this._oPreviousFocus=sap.ui.core.Popup.getCurrentFocusInfo();this.fireOpen();this.oPopup.open(400,m,a,o,O,"",true);return this};var g=function(t,m,a){if(!m&&t.oPopup){m=t.oPopup._oPosition.my}if(!a&&t.oPopup){a=t.oPopup._oPosition.at}if(m&&a){var b=m.split(" ");var c=a.split(" ");var r="my:"+b[0]+"|"+b[1];r+=" at:"+c[0]+"|"+c[1];if(sap.ui.ux3.ToolPopup.ARROW_LEFT.exec(r)){return"Left"}if(sap.ui.ux3.ToolPopup.ARROW_RIGHT.exec(r)){return"Right"}if(sap.ui.ux3.ToolPopup.ARROW_UP.exec(r)){return"Up"}if(sap.ui.ux3.ToolPopup.ARROW_DOWN.exec(r)){return"Down"}}return"Left"};sap.ui.ux3.ToolPopup.prototype.onsapescape=function(){if(this.fireClose()){this.close()}};sap.ui.ux3.ToolPopup.prototype.close=function(P){if(this.oPopup&&this.oPopup.isOpen()){if(this._bBoundOnResize){jQuery(window).unbind("resize",this._proxyFixTooLargeContent);delete this._bBoundOnResize}this.oPopup.close(400);this.fireEvent("close_always");if(!P){sap.ui.core.Popup.applyFocusInfo(this._oPreviousFocus)}}return this};sap.ui.commons.Dialog.prototype.getEnabled=function(){var e=this.oPopup?this.oPopup.getOpenState():sap.ui.core.OpenState.CLOSED;return e===sap.ui.core.OpenState.OPENING||e===sap.ui.core.OpenState.OPEN};sap.ui.ux3.ToolPopup.prototype.onsapenter=function(e){this.fireEnter({originalEvent:e,originalSrcControl:e.srcControl})};sap.ui.ux3.ToolPopup.prototype.onBeforeRendering=function(){var i=this.getInitialFocus();if(i){this._bFocusSet=true;this.oPopup.setInitialFocusId(i)}else{this._bFocusSet=false}this._bRTL=sap.ui.getCore().getConfiguration().getRTL()};sap.ui.ux3.ToolPopup.prototype._ensurePopup=function(){if(!this.oPopup){this.oPopup=new sap.ui.core.Popup(this,false,true,false);this.oPopup.attachClosed(jQuery.proxy(this.fireClosed,this));this.oPopup.attachOpened(this._proxyOpened);var t=this;this.oPopup._applyPosition=function(){var i=t.getId();sap.ui.core.Popup.prototype._applyPosition.apply(t.oPopup,arguments);var o=t.oPopup._oLastPosition.of;var $=jQuery.sap.byId(o.id);if(t._bPositionSet){if(!$.hasClass("sapUiUx3ShellTool")){var m=t.oPopup._oLastPosition.my;var a=t.oPopup._oLastPosition.at;t.sArrowDir=g(t,m,a)}}t._bPositionSet=false;var b=jQuery.sap.byId(i+"-arrow");var c=t.isInverted()?"sapUiUx3TPArrow sapUiTPInverted sapUiUx3TPArrow":"sapUiUx3TPArrow sapUiUx3TPArrow";b.attr("class",c+t.sArrowDir);if(t.sArrowDir==="Right"){var w=jQuery.sap.byId(i).outerWidth(true);var r="sap.ui.ux3.ToolPopup:";var A=r+"sapUiUx3ToolPopupArrowRightMarginCorrection";A=sap.ui.core.theming.Parameters.get(A);w+=parseInt(A);t._bRTL=sap.ui.getCore().getConfiguration().getRTL();if(t._bRTL){b.css("margin-right",w+"px")}else{b.css("margin-left",w+"px")}}}}return this.oPopup}}());
sap.ui.ux3.ToolPopup.prototype.setPosition=function(){this._ensurePopup();this.oPopup.setPosition.apply(this.oPopup,arguments);this._bPositionSet=true;return this};
sap.ui.ux3.ToolPopup.prototype.setIcon=function(i){this.setProperty("icon",i,true);this.fireIconChanged();return this};
sap.ui.ux3.ToolPopup.prototype.setIconHover=function(i){this.setProperty("iconHover",i,true);this.fireIconChanged();return this};
sap.ui.ux3.ToolPopup.prototype.setIconSelected=function(i){this.setProperty("iconSelected",i,true);this.fireIconChanged();return this};
sap.ui.ux3.ToolPopup.prototype.getIconSelected=function(){return this.getProperty("iconSelected")||this.getProperty("iconHover")};
sap.ui.ux3.ToolPopup.prototype.isInverted=function(){var p="sap.ui.ux3.ToolPopup:";p+="sapUiUx3ToolPopupInverted";p=sap.ui.core.theming.Parameters.get(p);var t=p==="true"?true:false;return this.getInverted()&&t};
