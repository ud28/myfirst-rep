/**
 * DropMenu.js
 *
 * Copyright, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */
(function(b){var i=b.is,D=b.DOM,f=b.each,E=b.dom.Event,g=b.dom.Element;b.create('tinymce.ui.DropMenu:tinymce.ui.Menu',{DropMenu:function(a,s){s=s||{};s.container=s.container||D.doc.body;s.offset_x=s.offset_x||0;s.offset_y=s.offset_y||0;s.vp_offset_x=s.vp_offset_x||0;s.vp_offset_y=s.vp_offset_y||0;if(i(s.icons)&&!s.icons)s['class']+=' mceNoIcons';this.parent(a,s);this.onShowMenu=new b.util.Dispatcher(this);this.onHideMenu=new b.util.Dispatcher(this);this.classPrefix='mceMenu'},createMenu:function(s){var t=this,c=t.settings,m;s.container=s.container||c.container;s.parent=t;s.constrain=s.constrain||c.constrain;s['class']=s['class']||c['class'];s.vp_offset_x=s.vp_offset_x||c.vp_offset_x;s.vp_offset_y=s.vp_offset_y||c.vp_offset_y;s.keyboard_focus=c.keyboard_focus;m=new b.ui.DropMenu(s.id||D.uniqueId(),s);m.onAddItem.add(t.onAddItem.dispatch,t.onAddItem);return m},focus:function(){var t=this;if(t.keyboardNav){t.keyboardNav.focus()}},update:function(){var t=this,s=t.settings,a=D.get('menu_'+t.id+'_tbl'),c=D.get('menu_'+t.id+'_co'),d,e;d=s.max_width?Math.min(a.offsetWidth,s.max_width):a.offsetWidth;e=s.max_height?Math.min(a.offsetHeight,s.max_height):a.offsetHeight;if(!D.boxModel)t.element.setStyles({width:d+2,height:e+2});else t.element.setStyles({width:d,height:e});if(s.max_width)D.setStyle(c,'width',d);if(s.max_height){D.setStyle(c,'height',e);if(a.clientHeight<s.max_height)D.setStyle(c,'overflow','hidden')}},showMenu:function(x,y,p){var t=this,s=t.settings,c,v=D.getViewPort(),w,h,a,d,j=2,k,l,n=t.classPrefix;t.collapse(1);if(t.isMenuVisible)return;if(!t.rendered){c=D.add(t.settings.container,t.renderNode());f(t.items,function(o){o.postRender()});t.element=new g('menu_'+t.id,{blocker:1,container:s.container})}else c=D.get('menu_'+t.id);if(!b.isOpera)D.setStyles(c,{left:-0xFFFF,top:-0xFFFF});D.show(c);t.update();x+=s.offset_x||0;y+=s.offset_y||0;v.w-=4;v.h-=4;if(s.constrain){w=c.clientWidth-j;h=c.clientHeight-j;a=v.x+v.w;d=v.y+v.h;if((x+s.vp_offset_x+w)>a)x=p?p-w:Math.max(0,(a-s.vp_offset_x)-w);if((y+s.vp_offset_y+h)>d)y=Math.max(0,(d-s.vp_offset_y)-h)}D.setStyles(c,{left:x,top:y});t.element.update();t.isMenuVisible=1;t.mouseClickFunc=E.add(c,'click',function(e){var m;e=e.target;if(e&&(e=D.getParent(e,'tr'))&&!D.hasClass(e,n+'ItemSub')){m=t.items[e.id];if(m.isDisabled())return;k=t;while(k){if(k.hideMenu)k.hideMenu();k=k.settings.parent}if(m.settings.onclick)m.settings.onclick(e);return false}});if(t.hasMenus()){t.mouseOverFunc=E.add(c,'mouseover',function(e){var m,r,o;e=e.target;if(e&&(e=D.getParent(e,'tr'))){m=t.items[e.id];if(t.lastMenu)t.lastMenu.collapse(1);if(m.isDisabled())return;if(e&&D.hasClass(e,n+'ItemSub')){r=D.getRect(e);m.showMenu((r.x+r.w-j),r.y-j,r.x);t.lastMenu=m;D.addClass(D.get(m.id).firstChild,n+'ItemActive')}}})}E.add(c,'keydown',t._keyHandler,t);t.onShowMenu.dispatch(t);if(s.keyboard_focus){t._setupKeyboardNav()}},hideMenu:function(c){var t=this,a=D.get('menu_'+t.id),e;if(!t.isMenuVisible)return;if(t.keyboardNav)t.keyboardNav.destroy();E.remove(a,'mouseover',t.mouseOverFunc);E.remove(a,'click',t.mouseClickFunc);E.remove(a,'keydown',t._keyHandler);D.hide(a);t.isMenuVisible=0;if(!c)t.collapse(1);if(t.element)t.element.hide();if(e=D.get(t.id))D.removeClass(e.firstChild,t.classPrefix+'ItemActive');t.onHideMenu.dispatch(t)},add:function(o){var t=this,c;o=t.parent(o);if(t.isRendered&&(c=D.get('menu_'+t.id)))t._add(D.select('tbody',c)[0],o);return o},collapse:function(d){this.parent(d);this.hideMenu(1)},remove:function(o){D.remove(o.id);this.destroy();return this.parent(o)},destroy:function(){var t=this,c=D.get('menu_'+t.id);if(t.keyboardNav)t.keyboardNav.destroy();E.remove(c,'mouseover',t.mouseOverFunc);E.remove(D.select('a',c),'focus',t.mouseOverFunc);E.remove(c,'click',t.mouseClickFunc);E.remove(c,'keydown',t._keyHandler);if(t.element)t.element.remove();D.remove(c)},renderNode:function(){var t=this,s=t.settings,n,a,c,w;w=D.create('div',{role:'listbox',id:'menu_'+t.id,'class':s['class'],'style':'position:absolute;left:0;top:0;z-index:200000;outline:0'});if(t.settings.parent){D.setAttrib(w,'aria-parent','menu_'+t.settings.parent.id)}c=D.add(w,'div',{role:'presentation',id:'menu_'+t.id+'_co','class':t.classPrefix+(s['class']?' '+s['class']:'')});t.element=new g('menu_'+t.id,{blocker:1,container:s.container});if(s.menu_line)D.add(c,'span',{'class':t.classPrefix+'Line'});n=D.add(c,'table',{role:'presentation',id:'menu_'+t.id+'_tbl',border:0,cellPadding:0,cellSpacing:0});a=D.add(n,'tbody');f(t.items,function(o){t._add(a,o)});t.rendered=true;return w},_setupKeyboardNav:function(){var c,m,t=this;c=D.get('menu_'+t.id);m=D.select('a[role=option]','menu_'+t.id);m.splice(0,0,c);t.keyboardNav=new b.ui.KeyboardNavigation({root:'menu_'+t.id,items:m,onCancel:function(){t.hideMenu()},enableUpDown:true});c.focus()},_keyHandler:function(a){var t=this,e;switch(a.keyCode){case 37:if(t.settings.parent){t.hideMenu();t.settings.parent.focus();E.cancel(a)}break;case 39:if(t.mouseOverFunc)t.mouseOverFunc(a);break}},_add:function(t,o){var n,s=o.settings,a,r,c,d=this.classPrefix,e;if(s.separator){r=D.add(t,'tr',{id:o.id,'class':d+'ItemSeparator'});D.add(r,'td',{'class':d+'ItemSeparator'});if(n=r.previousSibling)D.addClass(n,'mceLast');return}n=r=D.add(t,'tr',{id:o.id,'class':d+'Item '+d+'ItemEnabled'});n=c=D.add(n,s.titleItem?'th':'td');n=a=D.add(n,'a',{id:o.id+'_aria',role:s.titleItem?'presentation':'option',href:'javascript:;',onclick:"return false;",onmousedown:'return false;'});if(s.parent){D.setAttrib(a,'aria-haspopup','true');D.setAttrib(a,'aria-owns','menu_'+o.id)}D.addClass(c,s['class']);e=D.add(n,'span',{'class':'mceIcon'+(s.icon?' mce_'+s.icon:'')});if(s.icon_src)D.add(e,'img',{src:s.icon_src});n=D.add(n,s.element||'span',{'class':'mceText',title:o.settings.title},o.settings.title);if(o.settings.style){if(typeof o.settings.style=="function")o.settings.style=o.settings.style();D.setAttrib(n,'style',o.settings.style)}if(t.childNodes.length==1)D.addClass(r,'mceFirst');if((n=r.previousSibling)&&D.hasClass(n,d+'ItemSeparator'))D.addClass(r,'mceFirst');if(o.collapse)D.addClass(r,d+'ItemSub');if(n=r.previousSibling)D.removeClass(n,'mceLast');D.addClass(r,'mceLast')}})})(tinymce);
