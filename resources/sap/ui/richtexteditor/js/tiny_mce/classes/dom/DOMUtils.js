/**
 * DOMUtils.js
 *
 * Copyright, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */
(function(g){var j=g.each,l=g.is,m=g.isWebKit,q=g.isIE,E=g.html.Entities,z=/^([a-z0-9],?)+$/i,A=/^[ \t\r\n]*$/;g.create('tinymce.dom.DOMUtils',{doc:null,root:null,files:null,pixelStyles:/^(top|left|bottom|right|width|height|borderWidth)$/,props:{"for":"htmlFor","class":"className",className:"className",checked:"checked",disabled:"disabled",maxlength:"maxLength",readonly:"readOnly",selected:"selected",value:"value",id:"id",name:"name",type:"type"},DOMUtils:function(d,s){var t=this,a,n,b;t.doc=d;t.win=window;t.files={};t.cssFlicker=false;t.counter=0;t.stdMode=!g.isIE||d.documentMode>=8;t.boxModel=!g.isIE||d.compatMode=="CSS1Compat"||t.stdMode;t.hasOuterHTML="outerHTML"in d.createElement("a");t.settings=s=g.extend({keep_values:false,hex_colors:1},s);t.schema=s.schema;t.styles=new g.html.Styles({url_converter:s.url_converter,url_converter_scope:s.url_converter_scope},s.schema);if(g.isIE6){try{d.execCommand('BackgroundImageCache',false,true)}catch(e){t.cssFlicker=true}}t.fixDoc(d);t.events=s.ownEvents?new g.dom.EventUtils(s.proxy):g.dom.Event;g.addUnload(t.destroy,t);b=s.schema?s.schema.getBlockElements():{};t.isBlock=function(c){if(!c){return false}var f=c.nodeType;if(f)return!!(f===1&&b[c.nodeName]);return!!b[c]}},fixDoc:function(d){var s=this.settings,n;if(q&&s.schema){('abbr article aside audio canvas '+'details figcaption figure footer '+'header hgroup mark menu meter nav '+'output progress section summary '+'time video').replace(/\w+/g,function(n){d.createElement(n)});for(n in s.schema.getCustomElements()){d.createElement(n)}}},clone:function(n,d){var s=this,c,a;if(!q||n.nodeType!==1||d){return n.cloneNode(d)}a=s.doc;if(!d){c=a.createElement(n.nodeName);j(s.getAttribs(n),function(b){s.setAttrib(c,b.nodeName,s.getAttrib(n,b.nodeName))});return c}return c.firstChild},getRoot:function(){var t=this,s=t.settings;return(s&&t.get(s.root_element))||t.doc.body},getViewPort:function(w){var d,b;w=!w?this.win:w;d=w.document;b=this.boxModel?d.documentElement:d.body;return{x:w.pageXOffset||b.scrollLeft,y:w.pageYOffset||b.scrollTop,w:w.innerWidth||b.clientWidth,h:w.innerHeight||b.clientHeight}},getRect:function(e){var p,t=this,s;e=t.get(e);p=t.getPos(e);s=t.getSize(e);return{x:p.x,y:p.y,w:s.w,h:s.h}},getSize:function(e){var t=this,w,h;e=t.get(e);w=t.getStyle(e,'width');h=t.getStyle(e,'height');if(w.indexOf('px')===-1)w=0;if(h.indexOf('px')===-1)h=0;return{w:parseInt(w,10)||e.offsetWidth||e.clientWidth,h:parseInt(h,10)||e.offsetHeight||e.clientHeight}},getParent:function(n,f,r){return this.getParents(n,f,r,false)},getParents:function(n,f,r,c){var t=this,a,s=t.settings,o=[];n=t.get(n);c=c===undefined;if(s.strict_root)r=r||t.getRoot();if(l(f,'string')){a=f;if(f==='*'){f=function(n){return n.nodeType==1}}else{f=function(n){return t.is(n,a)}}}while(n){if(n==r||!n.nodeType||n.nodeType===9)break;if(!f||f(n)){if(c)o.push(n);else return n}n=n.parentNode}return c?o:null},get:function(e){var n;if(e&&this.doc&&typeof(e)=='string'){n=e;e=this.doc.getElementById(e);if(e&&e.id!==n)return this.doc.getElementsByName(n)[1]}return e},getNext:function(n,s){return this._findSib(n,s,'nextSibling')},getPrev:function(n,s){return this._findSib(n,s,'previousSibling')},select:function(p,s){var t=this;return g.dom.Sizzle(p,t.get(s)||t.get(t.settings.root_element)||t.doc,[])},is:function(n,s){var i;if(n.length===undefined){if(s==='*')return n.nodeType==1;if(z.test(s)){s=s.toLowerCase().split(/,/);n=n.nodeName.toLowerCase();for(i=s.length-1;i>=0;i--){if(s[i]==n)return true}return false}}return g.dom.Sizzle.matches(s,n.nodeType?[n]:n).length>0},add:function(p,n,a,h,c){var t=this;return this.run(p,function(p){var e,k;e=l(n,'string')?t.doc.createElement(n):n;t.setAttribs(e,a);if(h){if(h.nodeType)e.appendChild(h);else t.setHTML(e,h)}return!c?p.appendChild(e):e})},create:function(n,a,h){return this.add(this.doc.createElement(n),n,a,h,1)},createHTML:function(n,a,h){var o='',t=this,k;o+='<'+n;for(k in a){if(a.hasOwnProperty(k))o+=' '+k+'="'+t.encode(a[k])+'"'}if(typeof(h)!="undefined")return o+'>'+h+'</'+n+'>';return o+' />'},remove:function(n,k){return this.run(n,function(n){var c,p=n.parentNode;if(!p)return null;if(k){while(c=n.firstChild){if(!g.isIE||c.nodeType!==3||c.nodeValue)p.insertBefore(c,n);else n.removeChild(c)}}return p.removeChild(n)})},setStyle:function(n,c,v){var t=this;return t.run(n,function(e){var s,i;s=e.style;c=c.replace(/-(\D)/g,function(a,b){return b.toUpperCase()});if(t.pixelStyles.test(c)&&(g.is(v,'number')||/^[\-0-9\.]+$/.test(v)))v+='px';switch(c){case'opacity':if(q){s.filter=v===''?'':"alpha(opacity="+(v*100)+")";if(!n.currentStyle||!n.currentStyle.hasLayout)s.display='inline-block'}s[c]=s['-moz-opacity']=s['-khtml-opacity']=v||'';break;case'float':q?s.styleFloat=v:s.cssFloat=v;break;default:s[c]=v||''}if(t.settings.update_styles)t.setAttrib(e,'data-mce-style')})},getStyle:function(n,d,c){n=this.get(n);if(!n)return;if(this.doc.defaultView&&c){d=d.replace(/[A-Z]/g,function(a){return'-'+a});try{return this.doc.defaultView.getComputedStyle(n,null).getPropertyValue(d)}catch(e){return null}}d=d.replace(/-(\D)/g,function(a,b){return b.toUpperCase()});if(d=='float')d=q?'styleFloat':'cssFloat';if(n.currentStyle&&c)return n.currentStyle[d];return n.style?n.style[d]:undefined},setStyles:function(e,o){var t=this,s=t.settings,a;a=s.update_styles;s.update_styles=0;j(o,function(v,n){t.setStyle(e,n,v)});s.update_styles=a;if(s.update_styles)t.setAttrib(e,s.cssText)},removeAllAttribs:function(e){return this.run(e,function(e){var i,a=e.attributes;for(i=a.length-1;i>=0;i--){e.removeAttributeNode(a.item(i))}})},setAttrib:function(e,n,v){var t=this;if(!e||!n)return;if(t.settings.strict)n=n.toLowerCase();return this.run(e,function(e){var s=t.settings;var o=e.getAttribute(n);if(v!==null){switch(n){case"style":if(!l(v,'string')){j(v,function(v,n){t.setStyle(e,n,v)});return}if(s.keep_values){if(v&&!t._isRes(v))e.setAttribute('data-mce-style',v,2);else e.removeAttribute('data-mce-style',2)}e.style.cssText=v;break;case"class":e.className=v||'';break;case"src":case"href":if(s.keep_values){if(s.url_converter)v=s.url_converter.call(s.url_converter_scope||t,v,n,e);t.setAttrib(e,'data-mce-'+n,v,2)}break;case"shape":e.setAttribute('data-mce-style',v);break}}if(l(v)&&v!==null&&v.length!==0)e.setAttribute(n,''+v,2);else e.removeAttribute(n,2);if(tinyMCE.activeEditor&&o!=v){var a=tinyMCE.activeEditor;a.onSetAttrib.dispatch(a,e,n,v)}})},setAttribs:function(e,o){var t=this;return this.run(e,function(e){j(o,function(v,n){t.setAttrib(e,n,v)})})},getAttrib:function(e,n,d){var v,t=this,u;e=t.get(e);if(!e||e.nodeType!==1)return d===u?false:d;if(!l(d))d='';if(/^(src|href|style|coords|shape)$/.test(n)){v=e.getAttribute("data-mce-"+n);if(v)return v}if(q&&t.props[n]){v=e[t.props[n]];v=v&&v.nodeValue?v.nodeValue:v}if(!v)v=e.getAttribute(n,2);if(/^(checked|compact|declare|defer|disabled|ismap|multiple|nohref|noshade|nowrap|readonly|selected)$/.test(n)){if(e[t.props[n]]===true&&v==='')return n;return v?n:''}if(e.nodeName==="FORM"&&e.getAttributeNode(n))return e.getAttributeNode(n).nodeValue;if(n==='style'){v=v||e.style.cssText;if(v){v=t.serializeStyle(t.parseStyle(v),e.nodeName);if(t.settings.keep_values&&!t._isRes(v))e.setAttribute('data-mce-style',v)}}if(m&&n==="class"&&v)v=v.replace(/(apple|webkit)\-[a-z\-]+/gi,'');if(q){switch(n){case'rowspan':case'colspan':if(v===1)v='';break;case'size':if(v==='+0'||v===20||v===0)v='';break;case'width':case'height':case'vspace':case'checked':case'disabled':case'readonly':if(v===0)v='';break;case'hspace':if(v===-1)v='';break;case'maxlength':case'tabindex':if(v===32768||v===2147483647||v==='32768')v='';break;case'multiple':case'compact':case'noshade':case'nowrap':if(v===65535)return n;return d;case'shape':v=v.toLowerCase();break;default:if(n.indexOf('on')===0&&v)v=g._replace(/^function\s+\w+\(\)\s+\{\s+(.*)\s+\}$/,'$1',''+v)}}return(v!==u&&v!==null&&v!=='')?''+v:d},getPos:function(n,a){var t=this,x=0,y=0,e,d=t.doc,r;n=t.get(n);a=a||d.body;if(n){if(n.getBoundingClientRect){n=n.getBoundingClientRect();e=t.boxModel?d.documentElement:d.body;x=n.left+(d.documentElement.scrollLeft||d.body.scrollLeft)-e.clientTop;y=n.top+(d.documentElement.scrollTop||d.body.scrollTop)-e.clientLeft;return{x:x,y:y}}r=n;while(r&&r!=a&&r.nodeType){x+=r.offsetLeft||0;y+=r.offsetTop||0;r=r.offsetParent}r=n.parentNode;while(r&&r!=a&&r.nodeType){x-=r.scrollLeft||0;y-=r.scrollTop||0;r=r.parentNode}}return{x:x,y:y}},parseStyle:function(s){return this.styles.parse(s)},serializeStyle:function(o,n){return this.styles.serialize(o,n)},addStyle:function(c){var d=this.doc,h;styleElm=d.getElementById('mceDefaultStyles');if(!styleElm){styleElm=d.createElement('style'),styleElm.id='mceDefaultStyles';styleElm.type='text/css';h=d.getElementsByTagName('head')[0];if(h.firstChild){h.insertBefore(styleElm,h.firstChild)}else{h.appendChild(styleElm)}}if(styleElm.styleSheet){styleElm.styleSheet.cssText+=c}else{styleElm.appendChild(d.createTextNode(c))}},loadCSS:function(u){var t=this,d=t.doc,h;if(!u)u='';h=d.getElementsByTagName('head')[0];j(u.split(','),function(u){var a;if(t.files[u])return;t.files[u]=true;a=t.create('link',{rel:'stylesheet',href:g._addVer(u)});if(q&&d.documentMode&&d.recalc){a.onload=function(){if(d.recalc)d.recalc();a.onload=null}}h.appendChild(a)})},addClass:function(e,c){return this.run(e,function(e){var o;if(!c)return 0;if(this.hasClass(e,c))return e.className;o=this.removeClass(e,c);return e.className=(o!=''?(o+' '):'')+c})},removeClass:function(e,c){var t=this,r;return t.run(e,function(e){var v;if(t.hasClass(e,c)){if(!r)r=new RegExp("(^|\\s+)"+c+"(\\s+|$)","g");v=e.className.replace(r,' ');v=g.trim(v!=' '?v:'');e.className=v;if(!v){e.removeAttribute('class');e.removeAttribute('className')}return v}return e.className})},hasClass:function(n,c){n=this.get(n);if(!n||!c)return false;return(' '+n.className+' ').indexOf(' '+c+' ')!==-1},show:function(e){return this.setStyle(e,'display','block')},hide:function(e){return this.setStyle(e,'display','none')},isHidden:function(e){e=this.get(e);return!e||e.style.display=='none'||this.getStyle(e,'display')=='none'},uniqueId:function(p){return(!p?'mce_':p)+(this.counter++)},setHTML:function(e,h){var s=this;return s.run(e,function(e){if(q){while(e.firstChild)e.removeChild(e.firstChild);try{e.innerHTML='<br />'+h;e.removeChild(e.firstChild)}catch(a){var n=s.create('div');n.innerHTML='<br />'+h;j(g.grep(n.childNodes),function(b,i){if(i&&e.canHaveHTML)e.appendChild(b)})}}else e.innerHTML=h;return h})},getOuterHTML:function(e){var d,s=this;e=s.get(e);if(!e)return null;if(e.nodeType===1&&s.hasOuterHTML)return e.outerHTML;d=(e.ownerDocument||s.doc).createElement("body");d.appendChild(e.cloneNode(true));return d.innerHTML},setOuterHTML:function(e,h,d){var t=this;function s(e,h,d){var n,a;a=d.createElement("body");a.innerHTML=h;n=a.lastChild;while(n){t.insertAfter(n.cloneNode(true),e);n=n.previousSibling}t.remove(e)};return this.run(e,function(e){e=t.get(e);if(e.nodeType==1){d=d||e.ownerDocument||t.doc;if(q){try{if(q&&e.nodeType==1)e.outerHTML=h;else s(e,h,d)}catch(a){s(e,h,d)}}else s(e,h,d)}})},decode:E.decode,encode:E.encodeAllRaw,insertAfter:function(n,r){r=this.get(r);return this.run(n,function(n){var p,a;p=r.parentNode;a=r.nextSibling;if(a)p.insertBefore(n,a);else p.appendChild(n);return n})},replace:function(n,o,k){var t=this;if(l(o,'array'))n=n.cloneNode(true);return t.run(o,function(o){if(k){j(g.grep(o.childNodes),function(c){n.appendChild(c)})}return o.parentNode.replaceChild(n,o)})},rename:function(e,n){var t=this,a;if(e.nodeName!=n.toUpperCase()){a=t.create(n);j(t.getAttribs(e),function(b){t.setAttrib(a,b.nodeName,t.getAttrib(e,b.nodeName))});t.replace(a,e,1)}return a||e},findCommonAncestor:function(a,b){var p=a,c;while(p){c=b;while(c&&p!=c)c=c.parentNode;if(p==c)break;p=p.parentNode}if(!p&&a.ownerDocument)return a.ownerDocument.documentElement;return p},toHex:function(s){var c=/^\s*rgb\s*?\(\s*?([0-9]+)\s*?,\s*?([0-9]+)\s*?,\s*?([0-9]+)\s*?\)\s*$/i.exec(s);function h(s){s=parseInt(s,10).toString(16);return s.length>1?s:'0'+s};if(c){s='#'+h(c[1])+h(c[2])+h(c[3]);return s}return s},getClasses:function(){var t=this,c=[],i,a={},f=t.settings.class_filter,o;if(t.classes)return t.classes;function b(s){j(s.imports,function(r){b(r)});j(s.cssRules||s.rules,function(r){switch(r.type||1){case 1:if(r.selectorText){j(r.selectorText.split(','),function(v){v=v.replace(/^\s*|\s*$|^\s\./g,"");if(/\.mce/.test(v)||!/\.[\w\-]+$/.test(v))return;o=v;v=g._replace(/.*\.([a-z0-9_\-]+).*/i,'$1',v);if(f&&!(v=f(v,o)))return;if(!a[v]){c.push({'class':v});a[v]=1}})}break;case 3:b(r.styleSheet);break}})};try{j(t.doc.styleSheets,b)}catch(e){}if(c.length>0)t.classes=c;return c},run:function(e,f,s){var t=this,o;if(t.doc&&typeof(e)==='string')e=t.get(e);if(!e)return false;s=s||this;if(!e.nodeType&&(e.length||e.length===0)){o=[];j(e,function(e,i){if(e){if(typeof(e)=='string')e=t.doc.getElementById(e);o.push(f.call(s,e,i))}});return o}return f.call(s,e)},getAttribs:function(n){var o;n=this.get(n);if(!n)return[];if(q){o=[];if(n.nodeName=='OBJECT')return n.attributes;if(n.nodeName==='OPTION'&&this.getAttrib(n,'selected'))o.push({specified:1,nodeName:'selected'});n.cloneNode(false).outerHTML.replace(/<\/?[\w:\-]+ ?|=[\"][^\"]+\"|=\'[^\']+\'|=[\w\-]+|>/gi,'').replace(/[\w:\-]+/gi,function(a){o.push({specified:1,nodeName:a})});return o}return n.attributes},isEmpty:function(n,e){var s=this,i,a,t,w,b,c=0;n=n.firstChild;if(n){w=new g.dom.TreeWalker(n,n.parentNode);e=e||s.schema?s.schema.getNonEmptyElements():null;do{t=n.nodeType;if(t===1){if(n.getAttribute('data-mce-bogus'))continue;b=n.nodeName.toLowerCase();if(e&&e[b]){if(b==='br'){c++;continue}return false}a=s.getAttribs(n);i=n.attributes.length;while(i--){b=n.attributes[i].nodeName;if(b==="name"||b==='data-mce-bookmark')return false}}if(t==8)return false;if((t===3&&!A.test(n.nodeValue)))return false}while(n=w.next())}return c<=1},destroy:function(s){var t=this;t.win=t.doc=t.root=t.events=t.frag=null;if(!s)g.removeUnload(t.destroy)},createRng:function(){var d=this.doc;return d.createRange?d.createRange():new g.dom.Range(this)},nodeIndex:function(n,a){var i=0,b,c,d;if(n){for(b=n.nodeType,n=n.previousSibling,c=n;n;n=n.previousSibling){d=n.nodeType;if(a&&d==3){if(d==b||!n.nodeValue.length)continue}i++;b=d}}return i},split:function(p,e,a){var t=this,r=t.createRng(),b,c,d;function f(n){var i,h=n.childNodes,k=n.nodeType;function s(n){var u=n.previousSibling&&n.previousSibling.nodeName=='SPAN';var v=n.nextSibling&&n.nextSibling.nodeName=='SPAN';return u&&v}if(k==1&&n.getAttribute('data-mce-type')=='bookmark')return;for(i=h.length-1;i>=0;i--)f(h[i]);if(k!=9){if(k==3&&n.nodeValue.length>0){var o=g.trim(n.nodeValue).length;if(!t.isBlock(n.parentNode)||o>0||o===0&&s(n))return}else if(k==1){h=n.childNodes;if(h.length==1&&h[0]&&h[0].nodeType==1&&h[0].getAttribute('data-mce-type')=='bookmark')n.parentNode.insertBefore(h[0],n);if(h.length||/^(br|hr|input|img)$/i.test(n.nodeName))return}t.remove(n)}return n};if(p&&e){r.setStart(p.parentNode,t.nodeIndex(p));r.setEnd(e.parentNode,t.nodeIndex(e));b=r.extractContents();r=t.createRng();r.setStart(e.parentNode,t.nodeIndex(e)+1);r.setEnd(p.parentNode,t.nodeIndex(p)+1);c=r.extractContents();d=p.parentNode;d.insertBefore(f(b),p);if(a)d.replaceChild(a,e);else d.insertBefore(e,p);d.insertBefore(f(c),p);t.remove(p);return a||e}},bind:function(t,n,f,s){return this.events.add(t,n,f,s||this)},unbind:function(t,n,f){return this.events.remove(t,n,f)},fire:function(t,n,e){return this.events.fire(t,n,e)},getContentEditable:function(n){var c;if(n.nodeType!=1){return null}c=n.getAttribute("data-mce-contenteditable");if(c&&c!=="inherit"){return c}return n.contentEditable!=="inherit"?n.contentEditable:null},dumpRng:function(r){return'startContainer: '+r.startContainer.nodeName+', startOffset: '+r.startOffset+', endContainer: '+r.endContainer.nodeName+', endOffset: '+r.endOffset},_findSib:function(n,s,a){var t=this,f=s;if(n){if(l(f,'string')){f=function(n){return t.is(n,s)}}for(n=n[a];n;n=n[a]){if(f(n))return n}}return null},_isRes:function(c){return/^(top|left|bottom|right|width|height)/i.test(c)||/;\s*(top|left|bottom|right|width|height)/i.test(c)}});g.DOM=new g.dom.DOMUtils(document,{process_html:0})})(tinymce);
