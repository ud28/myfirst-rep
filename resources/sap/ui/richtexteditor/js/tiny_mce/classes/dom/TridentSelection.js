/**
 * TridentSelection.js
 *
 * Copyright, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */
(function(){function S(s){var a=this,d=s.dom,T=true,F=false;function g(r,c){var e,f=0,h,i,j,k,o,l,p=-1,m;e=r.duplicate();e.collapse(c);m=e.parentElement();if(m.ownerDocument!==s.dom.doc)return;while(m.contentEditable==="false"){m=m.parentNode}if(!m.hasChildNodes()){return{node:m,inside:1}}j=m.children;h=j.length-1;while(f<=h){l=Math.floor((f+h)/2);k=j[l];e.moveToElementText(k);p=e.compareEndPoints(c?'StartToStart':'EndToEnd',r);if(p>0){h=l-1}else if(p<0){f=l+1}else{return{node:k}}}if(p<0){if(!k){e.moveToElementText(m);e.collapse(true);k=m;i=true}else e.collapse(false);o=0;while(e.compareEndPoints(c?'StartToStart':'StartToEnd',r)!==0){if(e.move('character',1)===0||m!=e.parentElement()){break}o++}}else{e.collapse(true);o=0;while(e.compareEndPoints(c?'StartToStart':'StartToEnd',r)!==0){if(e.move('character',-1)===0||m!=e.parentElement()){break}o++}}return{node:k,position:p,offset:o,inside:i}};function b(){var i=s.getRng(),c=d.createRng(),e,f,t,h,j,k;e=i.item?i.item(0):i.parentElement();if(e.ownerDocument!=d.doc)return c;f=s.isCollapsed();if(i.item){c.setStart(e.parentNode,d.nodeIndex(e));c.setEnd(c.startContainer,c.startOffset+1);return c}function l(n){var o=g(i,n),p,q,r=0,u,v,w;p=o.node;q=o.offset;if(o.inside&&!p.hasChildNodes()){c[n?'setStart':'setEnd'](p,0);return}if(q===v){c[n?'setStartBefore':'setEndAfter'](p);return}if(o.position<0){u=o.inside?p.firstChild:p.nextSibling;if(!u){c[n?'setStartAfter':'setEndAfter'](p);return}if(!q){if(u.nodeType==3)c[n?'setStart':'setEnd'](u,0);else c[n?'setStartBefore':'setEndBefore'](u);return}while(u){w=u.nodeValue;r+=w.length;if(r>=q){p=u;r-=q;r=w.length-r;break}u=u.nextSibling}}else{u=p.previousSibling;if(!u)return c[n?'setStartBefore':'setEndBefore'](p);if(!q){if(p.nodeType==3)c[n?'setStart':'setEnd'](u,p.nodeValue.length);else c[n?'setStartAfter':'setEndAfter'](u);return}while(u){r+=u.nodeValue.length;if(r>=q){p=u;r-=q;break}u=u.previousSibling}}c[n?'setStart':'setEnd'](p,r)};try{l(true);if(!f)l()}catch(m){if(m.number==-2147024809){j=a.getBookmark(2);t=i.duplicate();t.collapse(true);e=t.parentElement();if(!f){t=i.duplicate();t.collapse(false);h=t.parentElement();h.innerHTML=h.innerHTML}e.innerHTML=e.innerHTML;a.moveToBookmark(j);i=s.getRng();l(true);if(!f)l()}else throw m}return c};this.getBookmark=function(t){var r=s.getRng(),c,e,f={};function h(n){var p,k,l,i,m=[];p=n.parentNode;k=d.getRoot().parentNode;while(p!=k&&p.nodeType!==9){l=p.children;i=l.length;while(i--){if(n===l[i]){m.push(i);break}}n=p;p=p.parentNode}return m};function j(c){var p;p=g(r,c);if(p){return{position:p.position,offset:p.offset,indexes:h(p.node),inside:p.inside}}};if(t===2){if(!r.item){f.start=j(true);if(!s.isCollapsed())f.end=j()}else f.start={ctrl:true,indexes:h(r.item(0))}}return f};this.moveToBookmark=function(c){var r,e=d.doc.body;function f(j){var n,i,k,l;n=d.getRoot();for(i=j.length-1;i>=0;i--){l=n.children;k=j[i];if(k<=l.length-1){n=l[k]}}return n};function h(i){var j=c[i?'start':'end'],m,k,u;if(j){m=j.position>0;k=e.createTextRange();k.moveToElementText(f(j.indexes));offset=j.offset;if(offset!==u){k.collapse(j.inside||m);k.moveStart('character',m?-offset:offset)}else k.collapse(i);r.setEndPoint(i?'StartToStart':'EndToStart',k);if(i)r.collapse(true)}};if(c.start){if(c.start.ctrl){r=e.createControlRange();r.addElement(f(c.start.indexes));r.select()}else{r=e.createTextRange();h(true);h();r.select()}}};this.addRange=function(r){var i,c,e,f,h,j,k,l=s.dom.doc,m=l.body,n,o;function p(t){var u,v,w,x,y;w=d.create('a');u=t?e:h;v=t?f:j;x=i.duplicate();if(u==l||u==l.documentElement){u=m;v=0}if(u.nodeType==3){u.parentNode.insertBefore(w,u);x.moveToElementText(w);x.moveStart('character',v);d.remove(w);i.setEndPoint(t?'StartToStart':'EndToEnd',x)}else{y=u.childNodes;if(y.length){if(v>=y.length){d.insertAfter(w,y[y.length-1])}else{u.insertBefore(w,y[v])}x.moveToElementText(w)}else if(u.canHaveHTML){u.innerHTML='<span>\uFEFF</span>';w=u.firstChild;x.moveToElementText(w);x.collapse(F)}i.setEndPoint(t?'StartToStart':'EndToEnd',x);d.remove(w)}}e=r.startContainer;f=r.startOffset;h=r.endContainer;j=r.endOffset;i=m.createTextRange();if(e==h&&e.nodeType==1){if(f==j&&!e.hasChildNodes()){if(e.canHaveHTML){k=e.previousSibling;if(k&&!k.hasChildNodes()&&d.isBlock(k)){k.innerHTML='\uFEFF'}else{k=null}e.innerHTML='<span>\uFEFF</span><span>\uFEFF</span>';i.moveToElementText(e.lastChild);i.select();d.doc.selection.clear();e.innerHTML='';if(k){k.innerHTML=''}return}else{f=d.nodeIndex(e);e=e.parentNode}}if(f==j-1){try{o=e.childNodes[f];c=m.createControlRange();c.addElement(o);c.select();n=s.getRng();if(n.item&&o===n.item(0)){return}}catch(q){}}}p(true);p();i.select()};this.getRangeAt=b};tinymce.dom.TridentSelection=S})();
