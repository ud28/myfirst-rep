/**
 * Selection.js
 *
 * Copyright, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */
(function(a){function b(s){return s.replace(/[\n\r]+/g,'')};var c=a.is,d=a.isIE,f=a.each,T=a.dom.TreeWalker;a.create('tinymce.dom.Selection',{Selection:function(g,w,s,h){var t=this;t.dom=g;t.win=w;t.serializer=s;t.editor=h;f(['onBeforeSetContent','onBeforeGetContent','onSetContent','onGetContent'],function(e){t[e]=new a.util.Dispatcher(t)});if(!t.win.getSelection)t.tridentSel=new a.dom.TridentSelection(t);if(a.isIE&&g.boxModel)this._fixIESelection();a.addUnload(t.destroy,t)},setCursorLocation:function(n,o){var t=this;var r=t.dom.createRng();r.setStart(n,o);r.setEnd(n,o);t.setRng(r);t.collapse(false)},getContent:function(s){var t=this,r=t.getRng(),e=t.dom.create("body"),g=t.getSel(),w,h,n;s=s||{};w=h='';s.get=true;s.format=s.format||'html';s.forced_root_block='';t.onBeforeGetContent.dispatch(t,s);if(s.format=='text')return t.isCollapsed()?'':(r.text||(g.toString?g.toString():''));if(r.cloneContents){n=r.cloneContents();if(n)e.appendChild(n)}else if(c(r.item)||c(r.htmlText)){e.innerHTML='<br>'+(r.item?r.item(0).outerHTML:r.htmlText);e.removeChild(e.firstChild)}else e.innerHTML=r.toString();if(/^\s/.test(e.innerHTML))w=' ';if(/\s+$/.test(e.innerHTML))h=' ';s.getInner=true;s.content=t.isCollapsed()?'':w+t.serializer.serialize(e,s)+h;t.onGetContent.dispatch(t,s);return s.content},setContent:function(e,g){var s=this,r=s.getRng(),h,i=s.win.document,j,t;g=g||{format:'html'};g.set=true;e=g.content=e;if(!g.no_events)s.onBeforeSetContent.dispatch(s,g);e=g.content;if(r.insertNode){e+='<span id="__caret">_</span>';if(r.startContainer==i&&r.endContainer==i){i.body.innerHTML=e}else{r.deleteContents();if(i.body.childNodes.length===0){i.body.innerHTML=e}else{if(r.createContextualFragment){r.insertNode(r.createContextualFragment(e))}else{j=i.createDocumentFragment();t=i.createElement('div');j.appendChild(t);t.outerHTML=e;r.insertNode(j)}}}h=s.dom.get('__caret');r=i.createRange();r.setStartBefore(h);r.setEndBefore(h);s.setRng(r);s.dom.remove('__caret');try{s.setRng(r)}catch(k){}}else{if(r.item){i.execCommand('Delete',false,null);r=s.getRng()}if(/^\s+/.test(e)){r.pasteHTML('<span id="__mce_tmp">_</span>'+e);s.dom.remove('__mce_tmp')}else r.pasteHTML(e)}if(!g.no_events)s.onSetContent.dispatch(s,g)},getStart:function(){var s=this,r=s.getRng(),e,p,g,n;if(r.duplicate||r.item){if(r.item)return r.item(0);g=r.duplicate();g.collapse(1);e=g.parentElement();if(e.ownerDocument!==s.dom.doc){e=s.dom.getRoot()}p=n=r.parentElement();while(n=n.parentNode){if(n==e){e=p;break}}return e}else{e=r.startContainer;if(e.nodeType==1&&e.hasChildNodes())e=e.childNodes[Math.min(e.childNodes.length-1,r.startOffset)];if(e&&e.nodeType==3)return e.parentNode;return e}},getEnd:function(){var s=this,r=s.getRng(),e,g;if(r.duplicate||r.item){if(r.item)return r.item(0);r=r.duplicate();r.collapse(0);e=r.parentElement();if(e.ownerDocument!==s.dom.doc){e=s.dom.getRoot()}if(e&&e.nodeName=='BODY')return e.lastChild||e;return e}else{e=r.endContainer;g=r.endOffset;if(e.nodeType==1&&e.hasChildNodes())e=e.childNodes[g>0?g-1:g];if(e&&e.nodeType==3)return e.parentNode;return e}},getBookmark:function(e,n){var t=this,g=t.dom,r,h,j,k,l,m,o,p='\uFEFF',s;function q(l,m){var o=0;f(g.select(l),function(x,i){if(x==m)o=i});return o};function u(r){function i(x){var y,z,A,B=x?'start':'end';y=r[B+'Container'];z=r[B+'Offset'];if(y.nodeType==1&&y.nodeName=="TR"){A=y.childNodes;y=A[Math.min(x?z:z-1,A.length-1)];if(y){z=x?0:y.childNodes.length;r['set'+(x?'Start':'End')](y,z)}}};i(true);i();return r};function v(){var r=t.getRng(true),i=g.getRoot(),x={};function y(r,z){var A=r[z?'startContainer':'endContainer'],B=r[z?'startOffset':'endOffset'],C=[],D,E,F=0;if(A.nodeType==3){if(n){for(D=A.previousSibling;D&&D.nodeType==3;D=D.previousSibling)B+=D.nodeValue.length}C.push(B)}else{E=A.childNodes;if(B>=E.length&&E.length){F=1;B=Math.max(0,E.length-1)}C.push(t.dom.nodeIndex(E[B],n)+F)}for(;A&&A!=i;A=A.parentNode)C.push(t.dom.nodeIndex(A,n));return C};x.start=y(r,true);if(!t.isCollapsed())x.end=y(r);return x};if(e==2){if(t.tridentSel)return t.tridentSel.getBookmark(e);return v()}if(e)return{rng:t.getRng()};r=t.getRng();j=g.uniqueId();k=tinyMCE.activeEditor.selection.isCollapsed();s='overflow:hidden;line-height:0px';if(r.duplicate||r.item){if(!r.item){h=r.duplicate();try{r.collapse();r.pasteHTML('<span data-mce-type="bookmark" id="'+j+'_start" style="'+s+'">'+p+'</span>');if(!k){h.collapse(false);r.moveToElementText(h.parentElement());if(r.compareEndPoints('StartToEnd',h)===0)h.move('character',-1);h.pasteHTML('<span data-mce-type="bookmark" id="'+j+'_end" style="'+s+'">'+p+'</span>')}}catch(w){return null}}else{m=r.item(0);l=m.nodeName;return{name:l,index:q(l,m)}}}else{m=t.getNode();l=m.nodeName;if(l=='IMG')return{name:l,index:q(l,m)};h=u(r.cloneRange());if(!k){h.collapse(false);h.insertNode(g.create('span',{'data-mce-type':"bookmark",id:j+'_end',style:s},p))}r=u(r);r.collapse(true);r.insertNode(g.create('span',{'data-mce-type':"bookmark",id:j+'_start',style:s},p))}t.moveToBookmark({id:j,keep:1});return{id:j}},moveToBookmark:function(e){var t=this,g=t.dom,m,h,r,j,s,k,l,n;function o(u){var v=e[u?'start':'end'],i,w,x,y;if(v){x=v[0];for(w=j,i=v.length-1;i>=1;i--){y=w.childNodes;if(v[i]>y.length-1)return;w=y[v[i]]}if(w.nodeType===3)x=Math.min(v[0],w.nodeValue.length);if(w.nodeType===1)x=Math.min(v[0],w.childNodes.length);if(u)r.setStart(w,x);else r.setEnd(w,x)}return true};function p(i){var u=g.get(e.id+'_'+i),v,w,x,y,z=e.keep;if(u){v=u.parentNode;if(i=='start'){if(!z){w=g.nodeIndex(u)}else{v=u.firstChild;w=1}s=k=v;l=n=w}else{if(!z){w=g.nodeIndex(u)}else{v=u.firstChild;w=1}k=v;n=w}if(!z){y=u.previousSibling;x=u.nextSibling;f(a.grep(u.childNodes),function(v){if(v.nodeType==3)v.nodeValue=v.nodeValue.replace(/\uFEFF/g,'')});while(u=g.get(e.id+'_'+i))g.remove(u,1);if(y&&x&&y.nodeType==x.nodeType&&y.nodeType==3&&!a.isOpera){w=y.nodeValue.length;y.appendData(x.nodeValue);g.remove(x);if(i=='start'){s=k=y;l=n=w}else{k=y;n=w}}}}};function q(i){if(g.isBlock(i)&&!i.innerHTML&&!d)i.innerHTML='<br data-mce-bogus="1" />';return i};if(e){if(e.start){r=g.createRng();j=g.getRoot();if(t.tridentSel)return t.tridentSel.moveToBookmark(e);if(o(true)&&o()){t.setRng(r)}}else if(e.id){p('start');p('end');if(s){r=g.createRng();r.setStart(q(s),l);r.setEnd(q(k),n);t.setRng(r)}}else if(e.name){t.select(g.select(e.name)[e.index])}else if(e.rng)t.setRng(e.rng)}},select:function(n,e){var t=this,g=t.dom,r=g.createRng(),i;function s(n,h){var w=new T(n,n);do{if(n.nodeType==3&&a.trim(n.nodeValue).length!==0){if(h)r.setStart(n,0);else r.setEnd(n,n.nodeValue.length);return}if(n.nodeName=='BR'){if(h)r.setStartBefore(n);else r.setEndBefore(n);return}}while(n=(h?w.next():w.prev()))};if(n){i=g.nodeIndex(n);r.setStart(n.parentNode,i);r.setEnd(n.parentNode,i+1);if(e){s(n,1);s(n)}t.setRng(r)}return n},isCollapsed:function(){var t=this,r=t.getRng(),s=t.getSel();if(!r||r.item)return false;if(r.compareEndPoints)return r.compareEndPoints('StartToEnd',r)===0;return!s||r.collapsed},collapse:function(t){var s=this,r=s.getRng(),n;if(r.item){n=r.item(0);r=s.win.document.body.createTextRange();r.moveToElementText(n)}r.collapse(!!t);s.setRng(r)},getSel:function(){var t=this,w=this.win;return w.getSelection?w.getSelection():w.document.selection},getRng:function(w){var s=this,e,r,g,h=s.win.document;if(w&&s.tridentSel){return s.tridentSel.getRangeAt(0)}try{if(e=s.getSel()){r=e.rangeCount>0?e.getRangeAt(0):(e.createRange?e.createRange():h.createRange())}}catch(i){}if(a.isIE&&r&&r.setStart&&h.selection.createRange().item){g=h.selection.createRange().item(0);r=h.createRange();r.setStartBefore(g);r.setEndAfter(g)}if(!r){r=h.createRange?h.createRange():h.body.createTextRange()}if(r.setStart&&r.startContainer.nodeType===9&&r.collapsed){g=s.dom.getRoot();r.setStart(g,0);r.setEnd(g,0)}if(s.selectedRange&&s.explicitRange){if(r.compareBoundaryPoints(r.START_TO_START,s.selectedRange)===0&&r.compareBoundaryPoints(r.END_TO_END,s.selectedRange)===0){r=s.explicitRange}else{s.selectedRange=null;s.explicitRange=null}}return r},setRng:function(r,e){var s,t=this;if(!t.tridentSel){s=t.getSel();if(s){t.explicitRange=r;try{s.removeAllRanges()}catch(g){}s.addRange(r);if(e===false&&s.extend){s.collapse(r.endContainer,r.endOffset);s.extend(r.startContainer,r.startOffset)}t.selectedRange=s.rangeCount>0?s.getRangeAt(0):null}}else{if(r.cloneRange){try{t.tridentSel.addRange(r);return}catch(g){}}try{r.select()}catch(g){}}},setNode:function(n){var t=this;t.setContent(t.dom.getOuterHTML(n));return n},getNode:function(){var t=this,r=t.getRng(),s=t.getSel(),e,g=r.startContainer,h=r.endContainer;function i(n,j){var o=n;while(n&&n.nodeType===3&&n.length===0){n=j?n.nextSibling:n.previousSibling}return n||o};if(!r)return t.dom.getRoot();if(r.setStart){e=r.commonAncestorContainer;if(!r.collapsed){if(r.startContainer==r.endContainer){if(r.endOffset-r.startOffset<2){if(r.startContainer.hasChildNodes())e=r.startContainer.childNodes[r.startOffset]}}if(g.nodeType===3&&h.nodeType===3){if(g.length===r.startOffset){g=i(g.nextSibling,true)}else{g=g.parentNode}if(r.endOffset===0){h=i(h.previousSibling,false)}else{h=h.parentNode}if(g&&g===h)return g}}if(e&&e.nodeType==3)return e.parentNode;return e}return r.item?r.item(0):r.parentElement()},getSelectedBlocks:function(s,e){var t=this,g=t.dom,h,i,n,j=[];h=g.getParent(s||t.getStart(),g.isBlock);i=g.getParent(e||t.getEnd(),g.isBlock);if(h)j.push(h);if(h&&i&&h!=i){n=h;var w=new T(h,g.getRoot());while((n=w.next())&&n!=i){if(g.isBlock(n))j.push(n)}}if(i&&h!=i)j.push(i);return j},isForward:function(){var e=this.dom,s=this.getSel(),g,h;if(!s||s.anchorNode==null||s.focusNode==null){return true}g=e.createRng();g.setStart(s.anchorNode,s.anchorOffset);g.collapse(true);h=e.createRng();h.setStart(s.focusNode,s.focusOffset);h.collapse(true);return g.compareBoundaryPoints(g.START_TO_START,h)<=0},normalize:function(){var s=this,r,n,e,g,h;function i(j){var k,o,w,l=s.dom,m=l.getRoot(),g,p,q;function t(g,v){var w=new T(g,l.getParent(g.parentNode,l.isBlock)||m);while(g=w[v?'prev':'next']()){if(g.nodeName==="BR"){return true}}};function u(v,x){var w,y;x=x||k;w=new T(x,l.getParent(x.parentNode,l.isBlock)||m);while(g=w[v?'prev':'next']()){if(g.nodeType===3&&g.nodeValue.length>0){k=g;o=v?g.nodeValue.length:0;n=true;return}if(l.isBlock(g)||p[g.nodeName.toLowerCase()]){return}y=g}if(e&&y){k=y;n=true;o=0}};k=r[(j?'start':'end')+'Container'];o=r[(j?'start':'end')+'Offset'];p=l.schema.getNonEmptyElements();if(k.nodeType===9){k=l.getRoot();o=0}if(k===m){if(j){g=k.childNodes[o>0?o-1:0];if(g){q=g.nodeName.toLowerCase();if(p[g.nodeName]||g.nodeName=="TABLE"){return}}}if(k.hasChildNodes()){k=k.childNodes[Math.min(!j&&o>0?o-1:o,k.childNodes.length-1)];o=0;if(k.hasChildNodes()&&!/TABLE/.test(k.nodeName)){g=k;w=new T(k,m);do{if(g.nodeType===3&&g.nodeValue.length>0){o=j?0:g.nodeValue.length;k=g;n=true;break}if(p[g.nodeName.toLowerCase()]){o=l.nodeIndex(g);k=g.parentNode;if(g.nodeName=="IMG"&&!j){o++}n=true;break}}while(g=(j?w.next():w.prev()))}}}if(e){if(k.nodeType===3&&o===0){u(true)}if(k.nodeType===1){g=k.childNodes[o];if(g&&g.nodeName==='BR'&&!t(g)&&!t(g,true)){u(true,k.childNodes[o])}}}if(j&&!e&&k.nodeType===3&&o===k.nodeValue.length){u(false)}if(n)r['set'+(j?'Start':'End')](k,o)};if(a.isIE)return;r=s.getRng();e=r.collapsed;i(true);if(!e)i();if(n){if(e){r.collapse(true)}s.setRng(r,s.isForward())}},selectorChanged:function(s,e){var g=this,h;if(!g.selectorChangedData){g.selectorChangedData={};h={};g.editor.onNodeChange.addToTop(function(i,j,n){var k=g.dom,p=k.getParents(n,null,k.getRoot()),m={};f(g.selectorChangedData,function(l,s){f(p,function(n){if(k.is(n,s)){if(!h[s]){f(l,function(e){e(true,{node:n,selector:s,parents:p})});h[s]=l}m[s]=l;return false}})});f(h,function(l,s){if(!m[s]){delete h[s];f(l,function(e){e(false,{node:n,selector:s,parents:p})})}})})}if(!g.selectorChangedData[s]){g.selectorChangedData[s]=[]}g.selectorChangedData[s].push(e);return g},scrollIntoView:function(e){var y,v,s=this,g=s.dom;v=g.getViewPort(s.editor.getWin());y=g.getPos(e).y;if(y<v.y||y+25>v.y+v.h){s.editor.getWin().scrollTo(0,y<v.y?y:y-v.h+25)}},destroy:function(m){var s=this;s.win=null;if(!m)a.removeUnload(s.destroy)},_fixIESelection:function(){var g=this.dom,h=g.doc,i=h.body,s,j,k;function r(x,y){var e=i.createTextRange();try{e.moveToPoint(x,y)}catch(n){e=null}return e};function l(e){var p;if(e.button){p=r(e.x,e.y);if(p){if(p.compareEndPoints('StartToStart',j)>0)p.setEndPoint('StartToStart',j);else p.setEndPoint('EndToEnd',j);p.select()}}else m()}function m(){var e=h.selection.createRange();if(j&&!e.item&&e.compareEndPoints('StartToEnd',e)===0)j.select();g.unbind(h,'mouseup',m);g.unbind(h,'mousemove',l);j=s=0};h.documentElement.unselectable=true;g.bind(h,['mousedown','contextmenu'],function(e){if(e.target.nodeName==='HTML'){if(s)m();k=h.documentElement;if(k.scrollHeight>k.clientHeight)return;s=1;j=r(e.x,e.y);if(j){g.bind(h,'mouseup',m);g.bind(h,'mousemove',l);g.win.focus();j.select()}}})}})})(tinymce);
