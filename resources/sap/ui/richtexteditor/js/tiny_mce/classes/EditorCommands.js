/**
 * EditorCommands.js
 *
 * Copyright, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */
(function(t){var e=t.each,u,T=true,F=false;t.EditorCommands=function(a){var d=a.dom,s=a.selection,c={state:{},exec:{},value:{}},b=a.settings,f=a.formatter,g;function h(o,p,v){var w;o=o.toLowerCase();if(w=c.exec[o]){w(o,p,v);return T}return F};function q(o){var p;o=o.toLowerCase();if(p=c.state[o])return p(o);return-1};function i(o){var p;o=o.toLowerCase();if(p=c.value[o])return p(o);return F};function j(o,p){p=p||'exec';e(o,function(v,w){e(w.toLowerCase().split(','),function(w){c[p][w]=v})})};t.extend(this,{execCommand:h,queryCommandState:q,queryCommandValue:i,addCommands:j});function k(o,p,v){if(p===u)p=F;if(v===u)v=null;return a.getDoc().execCommand(o,p,v)};function l(o){return f.match(o)};function m(o,v){f.toggle(o,v?{value:v}:u)};function n(o){g=s.getBookmark(o)};function r(){s.moveToBookmark(g)};j({'mceResetDesignMode,mceBeginUndoLevel':function(){},'mceEndUndoLevel,mceAddUndoLevel':function(){a.undoManager.add()},'Cut,Copy,Paste':function(o){var p=a.getDoc(),v;try{k(o)}catch(w){v=T}if(v||!p.queryCommandSupported(o)){if(t.isGecko){a.windowManager.confirm(a.getLang('clipboard_msg'),function(x){if(x)open('http://www.mozilla.org/editor/midasdemo/securityprefs.html','_blank')})}else a.windowManager.alert(a.getLang('clipboard_no_support'))}},unlink:function(o){if(s.isCollapsed())s.select(s.getNode());k(o);s.collapse(F)},'JustifyLeft,JustifyCenter,JustifyRight,JustifyFull':function(o){var p=o.substring(7);e('left,center,right,full'.split(','),function(v){if(p!=v)f.remove('align'+v)});m('align'+p);h('mceRepaint')},'InsertUnorderedList,InsertOrderedList':function(o){var p,v;k(o);p=d.getParent(s.getNode(),'ol,ul');if(p){v=p.parentNode;if(/^(H[1-6]|P|ADDRESS|PRE)$/.test(v.nodeName)){n();d.split(v,p);r()}}},'Bold,Italic,Underline,Strikethrough,Superscript,Subscript':function(o){m(o)},'ForeColor,HiliteColor,FontName':function(o,p,v){m(o,v)},FontSize:function(o,p,v){var w,x;if(v>=1&&v<=7){x=t.explode(b.font_size_style_values);w=t.explode(b.font_size_classes);if(w)v=w[v-1]||v;else v=x[v-1]||v}m(o,v)},RemoveFormat:function(o){f.remove(o)},mceBlockQuote:function(o){m('blockquote')},FormatBlock:function(o,p,v){return m(v||'p')},mceCleanup:function(){var g=s.getBookmark();a.setContent(a.getContent({cleanup:T}),{cleanup:T});s.moveToBookmark(g)},mceRemoveNode:function(o,p,v){var w=v||s.getNode();if(w!=a.getBody()){n();a.dom.remove(w,T);r()}},mceSelectNodeDepth:function(o,p,v){var w=0;d.getParent(s.getNode(),function(x){if(x.nodeType==1&&w++==v){s.select(x);return F}},a.getBody())},mceSelectNode:function(o,p,v){s.select(v)},mceInsertContent:function(o,p,v){var w,x,y,z,A,B,C,D,E,G,H,I,J,K;w=a.parser;x=new t.html.Serializer({},a.schema);J='<span id="mce_marker" data-mce-type="bookmark">\uFEFF</span>';B={content:v,format:'html'};s.onBeforeSetContent.dispatch(s,B);v=B.content;if(v.indexOf('{$caret}')==-1)v+='{$caret}';v=v.replace(/\{\$caret\}/,J);if(!s.isCollapsed())a.getDoc().execCommand('Delete',false,null);y=s.getNode();B={context:y.nodeName.toLowerCase()};A=w.parse(v,B);H=A.lastChild;if(H.attr('id')=='mce_marker'){C=H;for(H=H.prev;H;H=H.walk(true)){if(H.type==3||!d.isBlock(H.name)){H.parent.insert(C,H,H.name==='br');break}}}if(!B.invalid){v=x.serialize(A);H=y.firstChild;I=y.lastChild;if(!H||(H===I&&H.nodeName==='BR'))d.setHTML(y,v);else s.setContent(v)}else{s.setContent(J);y=s.getNode();z=a.getBody();if(y.nodeType==9)y=H=z;else H=y;while(H!==z){y=H;H=H.parentNode}v=y==z?z.innerHTML:d.getOuterHTML(y);v=x.serialize(w.parse(v.replace(/<span (id="mce_marker"|id=mce_marker).+?<\/span>/i,function(){return x.serialize(A)})));if(y==z)d.setHTML(z,v);else d.setOuterHTML(y,v)}C=d.get('mce_marker');D=d.getRect(C);E=d.getViewPort(a.getWin());if((D.y+D.h>E.y+E.h||D.y<E.y)||(D.x>E.x+E.w||D.x<E.x)){K=t.isIE?a.getDoc().documentElement:a.getBody();K.scrollLeft=D.x;K.scrollTop=D.y-E.h+25}G=d.createRng();H=C.previousSibling;if(H&&H.nodeType==3){G.setStart(H,H.nodeValue.length)}else{G.setStartBefore(C);G.setEndBefore(C)}d.remove(C);s.setRng(G);s.onSetContent.dispatch(s,B);a.addVisual()},mceInsertRawHTML:function(o,p,v){s.setContent('tiny_mce_marker');a.setContent(a.getContent().replace(/tiny_mce_marker/g,function(){return v}))},mceToggleFormat:function(o,p,v){m(v)},mceSetContent:function(o,p,v){a.setContent(v)},'Indent,Outdent':function(o){var p,v,w;p=b.indentation;v=/[a-z%]+$/i.exec(p);p=parseInt(p);if(!q('InsertUnorderedList')&&!q('InsertOrderedList')){if(!b.forced_root_block&&!d.getParent(s.getNode(),d.isBlock)){f.apply('div')}e(s.getSelectedBlocks(),function(x){if(o=='outdent'){w=Math.max(0,parseInt(x.style.paddingLeft||0)-p);d.setStyle(x,'paddingLeft',w?w+v:'')}else d.setStyle(x,'paddingLeft',(parseInt(x.style.paddingLeft||0)+p)+v)})}else k(o)},mceRepaint:function(){var g;if(t.isGecko){try{n(T);if(s.getSel())s.getSel().selectAllChildren(a.getBody());s.collapse(T);r()}catch(o){}}},mceToggleFormat:function(o,p,v){f.toggle(v)},InsertHorizontalRule:function(){a.execCommand('mceInsertContent',false,'<hr />')},mceToggleVisualAid:function(){a.hasVisual=!a.hasVisual;a.addVisual()},mceReplaceContent:function(o,p,v){a.execCommand('mceInsertContent',false,v.replace(/\{\$selection\}/g,s.getContent({format:'text'})))},mceInsertLink:function(o,p,v){var w;if(typeof(v)=='string')v={href:v};w=d.getParent(s.getNode(),'a');v.href=v.href.replace(' ','%20');if(!w||!v.href){f.remove('link')}if(v.href){f.apply('link',v,w)}},selectAll:function(){var o=d.getRoot(),p=d.createRng();if(s.getRng().setStart){p.setStart(o,0);p.setEnd(o,o.childNodes.length);s.setRng(p)}else{k('SelectAll')}}});j({'JustifyLeft,JustifyCenter,JustifyRight,JustifyFull':function(o){var p='align'+o.substring(7);var v=s.isCollapsed()?[d.getParent(s.getNode(),d.isBlock)]:s.getSelectedBlocks();var w=t.map(v,function(x){return!!f.matchNode(x,p)});return t.inArray(w,T)!==-1},'Bold,Italic,Underline,Strikethrough,Superscript,Subscript':function(o){return l(o)},mceBlockQuote:function(){return l('blockquote')},Outdent:function(){var o;if(b.inline_styles){if((o=d.getParent(s.getStart(),d.isBlock))&&parseInt(o.style.paddingLeft)>0)return T;if((o=d.getParent(s.getEnd(),d.isBlock))&&parseInt(o.style.paddingLeft)>0)return T}return q('InsertUnorderedList')||q('InsertOrderedList')||(!b.inline_styles&&!!d.getParent(s.getNode(),'BLOCKQUOTE'))},'InsertUnorderedList,InsertOrderedList':function(o){var p=d.getParent(s.getNode(),'ul,ol');return p&&(o==='insertunorderedlist'&&p.tagName==='UL'||o==='insertorderedlist'&&p.tagName==='OL')}},'state');j({'FontSize,FontName':function(o){var v=0,p;if(p=d.getParent(s.getNode(),'span')){if(o=='fontsize')v=p.style.fontSize;else v=p.style.fontFamily.replace(/, /g,',').replace(/[\'\"]/g,'').toLowerCase()}return v}},'value');j({Undo:function(){a.undoManager.undo()},Redo:function(){a.undoManager.redo()}})}})(tinymce);
