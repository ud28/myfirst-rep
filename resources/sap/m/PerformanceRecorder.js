/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2013 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.m.PerformanceRecorder");sap.m.PerformanceRecorder={};
sap.m.PerformanceRecorder.start=function(c,i){sap.m.PerformanceRecorder.config=c;sap.m.PerformanceRecorder.interactionSteps=i;sap.m.PerformanceRecorder.interactionPointer=0;sap.m.PerformanceRecorder.stepPointer=0;jQuery.sap.measure.setActive(true);sap.m.PerformanceRecorder.processStepStart()};
sap.m.PerformanceRecorder.processStepStart=function(){var c=sap.m.PerformanceRecorder.interactionSteps[sap.m.PerformanceRecorder.interactionPointer];var a=c.steps[sap.m.PerformanceRecorder.stepPointer];if(a.startTriggerEvent=="immediate"){if(sap.m.PerformanceRecorder.stepPointer==0){jQuery.sap.measure.start(c.id,c.description)}jQuery.sap.measure.start(a.id,c.id);sap.m.PerformanceRecorder.processStepStop()}else if(a.startTriggerEvent=="UIUpdated"){sap.ui.getCore().attachEvent(sap.ui.core.Core.M_EVENTS.UIUpdated,function(){if(sap.m.PerformanceRecorder.stepPointer==0){jQuery.sap.measure.start(c.id,c.description)}jQuery.sap.measure.start(a.id,c.id);sap.m.PerformanceRecorder.processStepStop()})}else if(a.startTriggerId&&a.startTriggerEvent){var t=sap.ui.getCore().byId(a.startTriggerId);sap.m.PerformanceRecorder.oTriggerEvent={};sap.m.PerformanceRecorder.oTriggerEvent[a.startTriggerEvent]=function(){if(sap.m.PerformanceRecorder.stepPointer==0){jQuery.sap.measure.start(c.id,c.description)}jQuery.sap.measure.start(a.id,c.id);sap.m.PerformanceRecorder.processStepStop()};t.addDelegate(sap.m.PerformanceRecorder.oTriggerEvent,true)}};
sap.m.PerformanceRecorder.processStepStop=function(){var c=sap.m.PerformanceRecorder.interactionSteps[sap.m.PerformanceRecorder.interactionPointer];var a=c.steps[sap.m.PerformanceRecorder.stepPointer];if(a.startTriggerEvent=="UIUpdated"){sap.ui.getCore().detachEvent(sap.ui.core.Core.M_EVENTS.UIUpdated,sap.m.PerformanceRecorder.processStepStop)}else if(a.startTriggerId&&a.startTriggerEvent){var t=sap.ui.getCore().byId(a.startTriggerId);t.removeDelegate(sap.m.PerformanceRecorder.oTriggerEvent)}if(a.stopTriggerEvent=="UIUpdated"){sap.ui.getCore().attachEvent(sap.ui.core.Core.M_EVENTS.UIUpdated,sap.m.PerformanceRecorder.concludeStep)}};
sap.m.PerformanceRecorder.concludeStep=function(){var c=sap.m.PerformanceRecorder.interactionSteps[sap.m.PerformanceRecorder.interactionPointer];var a=c.steps[sap.m.PerformanceRecorder.stepPointer];var l=sap.m.PerformanceRecorder.interactionSteps.length-1;var b=c.steps.length-1;jQuery.sap.measure.end(a.id);if(a.stopTriggerEvent=="UIUpdated"){sap.ui.getCore().detachEvent(sap.ui.core.Core.M_EVENTS.UIUpdated,sap.m.PerformanceRecorder.concludeStep)}if(sap.m.PerformanceRecorder.stepPointer==b){jQuery.sap.measure.end(c.id)}if(sap.m.PerformanceRecorder.interactionPointer<l){if(sap.m.PerformanceRecorder.stepPointer<b){sap.m.PerformanceRecorder.stepPointer++}else{sap.m.PerformanceRecorder.interactionPointer++;sap.m.PerformanceRecorder.stepPointer=0}sap.m.PerformanceRecorder.processStepStart()}else{sap.m.PerformanceRecorder.endRecording()}};
sap.m.PerformanceRecorder.endRecording=function(){var m=sap.m.PerformanceRecorder.getAllMeasurementsAsHAR();var d={log:{version:"1.2",creator:{name:"SAPUI5 Performance Recorder",version:"1.0"},browser:{name:navigator.userAgent,version:jQuery.browser.version}}};var p=[];var e=[];for(var i in m){if(m[i].id.substr(-5)==="_page"){var a={startedDateTime:m[i].startedDateTime,id:m[i].id,title:m[i].pageref,pageTimings:{onContentLoad:-1,onLoad:m[i].time}};p.push(a)}else{e.push(m[i])}}d.log.pages=p;d.log.entries=e;jQuery.ajax({type:'POST',url:sap.m.PerformanceRecorder.config.url,data:d,dataType:'text'})};
sap.m.PerformanceRecorder.getAllMeasurementsAsHAR=function(){var o=jQuery.sap.measure.getAllMeasurements();var m=new Array();var f=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"});jQuery.each(o,function(i,M){var a=f.format(new Date(M.start),true);m.push({id:M.id,pageref:M.info,startedDateTime:a,time:M.duration,request:{method:"GET",url:M.id,httpVersion:"HTTP/1.1",cookies:[{dummy:""}],headers:[{name:"",value:""}],queryString:[{name:"",value:""}],headersSize:0,bodySize:0},response:{status:200,statusText:"OK",httpVersion:"HTTP/1.1",cookies:[{dummy:""}],headers:[{name:"",value:""}],content:{size:0,compression:0,mimeType:"text/html; charset=utf-8",text:"\n"},redirectURL:"",headersSize:0,bodySize:0},cache:{beforeRequest:{lastAccess:"",eTag:"",hitCount:""},afterRequest:{lastAccess:"",eTag:"",hitCount:""}},timings:{blocked:-1,dns:-1,connect:-1,send:-1,wait:-1,receive:M.duration,ssl:-1,}})});return m};
